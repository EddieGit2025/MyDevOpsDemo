name: Deploy to Local IIS

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Build
      run: dotnet build --configuration Release

    - name: Publish
      run: dotnet publish --configuration Release --output ./publish_output

    # --- 改良區開始 ---
    
    # 1. 先關閉電源
    - name: Stop AppPool
      run: Stop-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue

    # 2. 【關鍵】讓子彈飛一會兒 (等待釋放鎖定)
    - name: Wait for AppPool to Stop
      run: Start-Sleep -Seconds 5

    # 3. 複製檔案
    - name: Copy Files
      run: Copy-Item -Path ".\publish_output\*" -Destination "C:\inetpub\wwwroot\MyApi" -Recurse -Force

    # 4. 【關鍵】無論上面發生什麼事，一定要把電源打開！
    # if: always() 代表就算上面複製失敗，這一步也會執行，避免 503 慘劇
    - name: Start AppPool
      if: always()
      run: Start-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue
      
    # --- 改良區結束 ---

    - name: Verify
      run: echo "Deployment finished!"
