name: Deploy to Local IIS

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    # 1. 下載程式碼
    - uses: actions/checkout@v4

    # [已刪除] Setup .NET 步驟
    # 因為您的電腦已經有安裝了，不需要讓 Runner 冒著權限不足的風險去重裝

    # 2. 還原與編譯 (直接呼叫電腦裡的 dotnet 指令)
    - name: Build
      run: dotnet build --configuration Release

    # 3. 發布 (打包)
    - name: Publish
      run: dotnet publish --configuration Release --output ./publish_output

    # 4. 部署到 IIS
    - name: Deploy to IIS Folder
      run: |
        # 嘗試停止 AppPool (如果沒這個站台就略過錯誤)
        Stop-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue
        
        # 複製檔案 (強制覆寫)
        Copy-Item -Path ".\publish_output\*" -Destination "C:\inetpub\wwwroot\MyApi" -Recurse -Force
        
        # 重新啟動 AppPool
        Start-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue

    - name: Verify
      run: echo "Deployment finished!"
