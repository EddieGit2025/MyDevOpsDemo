name: Deploy to Local IIS

on:
  push:
    branches: [ "master" ] # 確認您的分支名稱是 master

jobs:
  build-and-deploy:
    # 關鍵改變：指定用您自己的電腦跑
    runs-on: self-hosted

    steps:
    # 1. 下載程式碼
    - uses: actions/checkout@v4

    # 2. 設定 .NET 環境 (雖然您電腦有裝，但這步是好習慣)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # 3. 還原與編譯
    - name: Build
      run: dotnet build --configuration Release

    # 4. 發布 (打包成 DLL)
    - name: Publish
      run: dotnet publish --configuration Release --output ./publish_output

    # 5. 部署 (將檔案複製到 IIS 資料夾)
    # 注意：這裡使用 PowerShell 指令直接複製
    - name: Deploy to IIS Folder
      run: |
        # 先停止 AppPool 以免檔案被鎖定 (第一次部署可忽略錯誤)
        Stop-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue
        
        # 複製檔案 (強制覆寫)
        Copy-Item -Path ".\publish_output\*" -Destination "C:\inetpub\wwwroot\MyApi" -Recurse -Force
        
        # 重新啟動 AppPool
        Start-WebAppPool -Name "DefaultAppPool" -ErrorAction SilentlyContinue

    # 6. 驗證
    - name: Verify Deployment
      run: echo "Deployment finished! Check C:\inetpub\wwwroot\MyApi"
